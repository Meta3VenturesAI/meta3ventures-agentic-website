import{s as t}from"./supabase-gsyK_hHB.js";const e=new class{async storeFormSubmission(e){try{if(this.storeLocally("form_submissions",e),t){const{error:a}=await t.from("form_submissions").insert({...e,created_at:(new Date).toISOString()})}this.trackFormSubmission(e),this.exportToCSV(e)}catch(a){this.storeLocally("form_submissions_backup",e)}}storeLocally(t,e){const a=JSON.parse(localStorage.getItem(t)||"[]");a.push({...e,timestamp:(new Date).toISOString(),id:this.generateId()}),a.length>1e3&&a.splice(0,a.length-1e3),localStorage.setItem(t,JSON.stringify(a))}trackFormSubmission(t){"undefined"!=typeof window&&window.gtag&&window.gtag("event","form_submission",{event_category:"engagement",event_label:t.type,value:1});const e={event_type:`form_${t.type}`,event_data:{form_type:t.type,fields_count:Object.keys(t.data).length},session_id:this.getSessionId(),created_at:(new Date).toISOString()};this.storeAnalyticsEvent(e)}async trackEvent(t){const e={event_type:t.event_type||"custom_event",event_data:t.event_data||{},session_id:t.session_id||this.getSessionId(),user_id:t.user_id,created_at:t.created_at||(new Date).toISOString()};await this.storeAnalyticsEvent(e)}async storeAnalyticsEvent(e){try{this.storeLocally("analytics_events",e),t&&await t.from("analytics_events").insert(e)}catch(a){}}exportToCSV(t){const e=JSON.parse(localStorage.getItem("csv_export_queue")||"[]");e.push({...t,exported_at:(new Date).toISOString()}),localStorage.setItem("csv_export_queue",JSON.stringify(e))}async getAllSubmissions(e){try{if(t){const a=t.from("form_submissions").select("*");e&&a.eq("type",e);const{data:s,error:n}=await a.order("created_at",{ascending:!1});if(!n&&s)return s}const a=JSON.parse(localStorage.getItem("form_submissions")||"[]");return e?a.filter(t=>t.type===e):a}catch(a){return[]}}async getSubmissionsByType(t){return JSON.parse(localStorage.getItem("form_submissions")||"[]").filter(e=>e.type===t)}async getAnalyticsSummary(){const t=await this.getAllSubmissions(),e=JSON.parse(localStorage.getItem("analytics_events")||"[]");return{total_submissions:t.length,by_type:{contact:t.filter(t=>"contact"===t.type).length,apply:t.filter(t=>"apply"===t.type).length,newsletter:t.filter(t=>"newsletter"===t.type).length,chat:t.filter(t=>"chat"===t.type).length},recent_submissions:t.slice(0,10),total_events:e.length,unique_sessions:new Set(e.map(t=>t.session_id)).size}}downloadCSV(t){const e=JSON.parse(localStorage.getItem("form_submissions")||"[]"),a=t?e.filter(e=>e.type===t):e;if(0===a.length)return;const s=a.map(t=>[t.timestamp||t.created_at,t.type,t.data.name||t.data.founderName||"",t.data.email||"",t.data.company||t.data.companyName||"",t.data.message||t.data.pitch||"",JSON.stringify(t.data)]),n=[["Date","Type","Name","Email","Company","Message","Additional Data"].join(","),...s.map(t=>t.map(t=>`"${t}"`).join(","))].join("\n"),i=new Blob([n],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),r=URL.createObjectURL(i);o.setAttribute("href",r),o.setAttribute("download",`meta3_${t||"all"}_submissions_${(new Date).toISOString().split("T")[0]}.csv`),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)}async clearOldData(e=90){const a=new Date;a.setDate(a.getDate()-e);["form_submissions","analytics_events","csv_export_queue"].forEach(t=>{const e=JSON.parse(localStorage.getItem(t)||"[]").filter(t=>new Date(t.timestamp||t.created_at)>a);localStorage.setItem(t,JSON.stringify(e))}),t&&await t.from("form_submissions").delete().lt("created_at",a.toISOString())}generateId(){return Math.random().toString(36).substring(2)+Date.now().toString(36)}getSessionId(){let t=sessionStorage.getItem("session_id");return t||(t=this.generateId(),sessionStorage.setItem("session_id",t)),t}async getStructuredData(){const t=await this.getAllSubmissions();return{contacts:t.filter(t=>"contact"===t.type).map(t=>({name:t.data.name,email:t.data.email,message:t.data.message,date:t.created_at})),applications:t.filter(t=>"apply"===t.type).map(t=>({company:t.data.companyName,founder:t.data.founderName,email:t.data.email,website:t.data.website,pitch:t.data.pitch,stage:t.data.stage,date:t.created_at})),newsletter:t.filter(t=>"newsletter"===t.type).map(t=>({email:t.data.email,name:t.data.name,preferences:t.data.preferences,date:t.created_at})),chat_conversations:t.filter(t=>"chat"===t.type).map(t=>({messages:t.data.messages,context:t.data.context,duration:t.data.duration,date:t.created_at}))}}};export{e as d};
